--// SUPER ANTI-FLING 2024 – LocalScript
--  by ChatGPT, tuỳ chỉnh freely

------------------------------------------------------------------
-- SERVICES
------------------------------------------------------------------
local RunService   = game:GetService("RunService")
local Players      = game:GetService("Players")
local Physics      = game:GetService("PhysicsService")
local Workspace    = game:GetService("Workspace")

local lp = Players.LocalPlayer

------------------------------------------------------------------
-- CONFIG
------------------------------------------------------------------
local VELOCITY_HARD_LIMIT   = 60      -- stud/s
local ANGULAR_HARD_LIMIT    = 80      -- rad/s
local NOCOLLIDE_RADIUS      = 6       -- xoá part lạ <6 stud
local SAFE_HEIGHT_FLOOR     = -30     -- rơi dưới thì hồi về
local ANCHOR_TIME           = 0.08    -- số giây khóa nhân vật khi reset
local VERBOSE_PRINT         = false   -- bật log

------------------------------------------------------------------
-- UTIL
------------------------------------------------------------------
local function dprint(...) if VERBOSE_PRINT then print("[AF]", ...) end end

local function dangerousBody(obj: Instance): boolean
	return obj:IsA("BodyMover") or obj:IsA("BodyGyro") or obj:IsA("BodyForce")
		or obj:IsA("VectorForce") or obj:IsA("Torque") or obj:IsA("Constraint")
		or obj:IsA("LinearVelocity") or obj:IsA("AngularVelocity")
end

------------------------------------------------------------------
-- MAIN PROTECTION
------------------------------------------------------------------
local function protect(char: Model)
	local hrp   = char:WaitForChild("HumanoidRootPart", 3)
	local hum   = char:WaitForChild("Humanoid", 3)
	if not hrp or not hum then return end

	-- tạo collision group riêng cho player để noclip part lạ dễ
	pcall(function()
		if not Physics:CollisionGroupExists("AntiFlingPlayer") then
			Physics:CreateCollisionGroup("AntiFlingPlayer")
			Physics:CollisionGroupSetCollidable("AntiFlingPlayer", "Default", true)
		end
	end)
	for _,p in ipairs(char:GetDescendants()) do
		if p:IsA("BasePart") then
			p.CollisionGroup = "AntiFlingPlayer"
		end
	end
	char.DescendantAdded:Connect(function(part)
		if part:IsA("BasePart") then
			part.CollisionGroup = "AntiFlingPlayer"
		end
	end)

	-- xoá bodymover/constraint mới gắn
	local function onDescAdded(obj)
		if dangerousBody(obj) then
			dprint("Destroy body mover:",obj.ClassName)
			obj:Destroy()
		end
	end
	-- quét lần đầu
	for _,d in ipairs(char:GetDescendants()) do onDescAdded(d) end
	char.DescendantAdded:Connect(onDescAdded)

	------------------------------------------------------------------
	-- RESET ROUTINE
	------------------------------------------------------------------
	local safeCF = hrp.CFrame
	local lastReset = 0
	local anchoring = false

	local function hardReset()
		if tick()-lastReset < 0.3 then return end -- tránh spam
		lastReset = tick()

		anchoring = true
		local oldAnchors = {}
		for _,bp in ipairs(char:GetDescendants()) do
			if bp:IsA("BasePart") then
				oldAnchors[bp] = bp.Anchored
				bp.Anchored = true
				bp.Velocity     = Vector3.zero
				bp.RotVelocity  = Vector3.zero
			end
		end

		hrp.CFrame = safeCF

		task.delay(ANCHOR_TIME, function()
			for part,old in pairs(oldAnchors) do
				if part and part.Parent then part.Anchored = old end
			end
			anchoring = false
		end)
	end

	------------------------------------------------------------------
	-- WATCH DOG (Stepped)
	------------------------------------------------------------------
	RunService.Stepped:Connect(function(_,dt)
		if not hrp.Parent then return end
		if anchoring then return end

		-- update safeCF khi bình thường
		if hrp.Velocity.Magnitude < VELOCITY_HARD_LIMIT/2
			and hrp.RotVelocity.Magnitude < ANGULAR_HARD_LIMIT/2
			and hrp.Position.Y > SAFE_HEIGHT_FLOOR
		then
			safeCF = hrp.CFrame
		end

		-- nếu vượt ngưỡng ⇒ reset
		if hrp.Velocity.Magnitude > VELOCITY_HARD_LIMIT
			or hrp.RotVelocity.Magnitude > ANGULAR_HARD_LIMIT
			or hrp.Position.Y < SAFE_HEIGHT_FLOOR
		then
			dprint("⚠️ Hard Reset | V=",hrp.Velocity.Magnitude," Rot=",hrp.RotVelocity.Magnitude)
			hardReset()
		end

		-- Xoá part nhẹ (massless) bay vào người
		for _,part in ipairs(Workspace:GetPartBoundsInBox(hrp.CFrame,
			Vector3.new(NOCOLLIDE_RADIUS,NOCOLLIDE_RADIUS,NOCOLLIDE_RADIUS))) do

			if part:IsA("BasePart") and part.CanCollide
				and not part:IsDescendantOf(char)
				and part.AssemblyMass < 2 -- cực nhẹ, nghi vấn 
			then
				dprint("Delete suspect part:", part:GetFullName())
				part:Destroy()
			end
		end
	end)

	------------------------------------------------------------------
	-- GIỮ NETWORK OWNERSHIP (executor safe)
	------------------------------------------------------------------
	local ok, setsim = pcall(function() return setsimulationradius end)
	if ok and typeof(setsim)=="function" then
		RunService.RenderStepped:Connect(function()
			setsim(1e3,1e3)
		end)
	end
end

------------------------------------------------------------------
-- HOOK CHARACTER
------------------------------------------------------------------
if lp.Character then task.spawn(protect, lp.Character) end
lp.CharacterAdded:Connect(function(c) task.spawn(protect, c) end)
