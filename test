--// Anti-Fling (LocalScript) – by ChatGPT
--  Copy vào StarterPlayerScripts hoặc chạy qua Executor (nếu bạn không phải chủ map).

local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")

------------------------------------------------------------------
-- CÁC THÔNG SỐ CÓ THỂ TÙY CHỈNH
------------------------------------------------------------------
local VELOCITY_LIMIT  = 100      -- Nếu tốc độ vượt ngưỡng này → reset
local ANGULAR_LIMIT   = 100      -- Ngưỡng xoay
local SAFE_HEIGHT_FLOOR = -20    -- Dưới ngưỡng Y này thì coi là rơi (teleport về vị trí an toàn)

------------------------------------------------------------------
-- TIỆN ÍCH
------------------------------------------------------------------
local function isBodyMover(obj)
	-- Các object thường dùng để fling
	return obj:IsA("BodyVelocity") or obj:IsA("BodyAngularVelocity")
		or obj:IsA("BodyPosition") or obj:IsA("BodyForce")
		or obj:IsA("BodyGyro")     or obj:IsA("BodyThrust")
		or obj:IsA("LinearVelocity") or obj:IsA("AngularVelocity")
		or obj:IsA("VectorForce")  or obj:IsA("Torque")
end

------------------------------------------------------------------
-- HÀM CHÍNH
------------------------------------------------------------------
local function protectCharacter(char: Model)
	local hrp      = char:WaitForChild("HumanoidRootPart", 5)
	local humanoid = char:WaitForChild("Humanoid", 5)
	if not hrp or not humanoid then return end
	
	-- Điểm an toàn ban đầu
	local safeCFrame = hrp.CFrame
	
	------------------------------------------------------------------
	-- 1. TỰ ĐỘNG XÓA BodyMovers / Constraint đáng ngờ được chèn vào bạn
	------------------------------------------------------------------
	local function onDescAdded(obj)
		if isBodyMover(obj) or obj:IsA("Constraint") then
			obj:Destroy()
		end
	end
	
	-- Quét toàn bộ lần đầu
	for _, d in ipairs(char:GetDescendants()) do
		onDescAdded(d)
	end
	-- Lắng nghe tiếp
	char.DescendantAdded:Connect(onDescAdded)
	
	------------------------------------------------------------------
	-- 2. Theo dõi vận tốc & khôi phục
	------------------------------------------------------------------
	RunService.Stepped:Connect(function()
		if not hrp:IsDescendantOf(workspace) then return end  -- nhân vật đã chết
		
		local vMag   = hrp.Velocity.Magnitude
		local rMag   = hrp.RotVelocity.Magnitude
		local yPos   = hrp.Position.Y
		
		-- Nếu bị đẩy quá nhanh, xoay quá mạnh, hoặc rơi xuống void
		if vMag > VELOCITY_LIMIT or rMag > ANGULAR_LIMIT or yPos < SAFE_HEIGHT_FLOOR then
			-- Reset về vị trí an toàn
			hrp.CFrame     = safeCFrame
			hrp.Velocity   = Vector3.zero
			hrp.RotVelocity= Vector3.zero
		else
			-- Cập nhật vị trí an toàn liên tục khi mọi thứ “bình thường”
			safeCFrame = hrp.CFrame
		end
	end)
	
	------------------------------------------------------------------
	-- 3. Gán mô phỏng (tùy chọn – có thể cần executor)
	------------------------------------------------------------------
	-- Một số executor cho phép setsimulationradius ẩn
	local ok, setsim = pcall(function() return setsimulationradius end)
	if ok and type(setsim)=="function" then
		RunService.RenderStepped:Connect(function()
			-- Giữ quyền network ownership quanh 1000 stud
			setsim(1e3, 1e3)
		end)
	end
end

------------------------------------------------------------------
-- KÍCH HOẠT VỚI NHÂN VẬT HIỆN TẠI & CÁC LẦN HỒI SINH
------------------------------------------------------------------
local lp = Players.LocalPlayer
if lp.Character then
	coroutine.wrap(protectCharacter)(lp.Character)
end
lp.CharacterAdded:Connect(function(char)
	coroutine.wrap(protectCharacter)(char)
end)
